---
# tasks file for apache_nginx_php_phpmyadmin

#######################################
################## NGINX ###############
#####################################

- name: install epel
  yum: name=epel-release state=installed

- name: install nginx
  yum: name=nginx state=installed

- name: remove epel
  yum: name=epel-release state=removed

- name: copy default.conf
  copy: src=default.conf dest={{ nginx_conf_d }}

## generated by openssl

- name: copy cert.crt
  copy: src=cert.crt dest={{ nginx_d }}

- name: copy cert.key
  copy: src=cert.key dest={{ nginx_d }}

#############################################
################## APACHE ##################
####################################

- name: install httpd
  yum: name=httpd state=installed

- name: copy httpd.conf
  copy: src=httpd.conf dest={{ httpd_d }}

########################################
############### PHP ###################
#######################################

- name: Download remi rep
  get_url: url=http://rpms.remirepo.net/enterprise/remi-release-6.rpm dest=/tmp

- name: Install yum-utils
  yum: name=yum-utils state=installed

- name: Install Remi rep
  yum:
   name: /tmp/remi-release-6.rpm
   state: installed

- name: install php56
  yum: name=php56-php.x86_64 state=installed

- name: install php56 required modules
  yum: name={{ item }}
       state=installed
  with_items:
   - php56-php-mbstring
   - php56-php-cli
   - php56-php-common
   - php56-php-devel
   - php56-php-pdo
   - php56-php-pear
   - php56-php-mysqlnd
   - php56-php-gd
   - php56-php-fpm
   - php56-php-xml

- name: install opcache
  yum: name=php56-php-opcache state=installed

- name: copy 10-opcache.ini
  copy: src=10-opcache.ini dest={{ opt_php_d }}

- name: copy info.php
  copy: src=info.php dest={{ www_wordpress }}

########################################
############### PhpMyAdmin ###################
#######################################

- name: install phpMyAdmin
  yum: name=phpmyadmin state=installed

- name: Download PhpMyAdmin
  get_url: url=https://files.phpmyadmin.net/phpMyAdmin/4.9.0.1/phpMyAdmin-4.9.0.1-all-languages.tar.gz dest=/tmp

- name: tar PhpMyAdmin
  command: tar zxvf /tmp/phpMyAdmin-4.9.0.1-all-languages.tar.gz -C {{ www_wordpress }}

- name: tar PhpMyAdmin
  command: mv {{ www_wordpress }}/phpMyAdmin-4.9.0.1-all-languages {{ www_wordpress }}/phpMyAdmin

- name: Insert ForceSSL Line in phpMyAdmin config 
  replace: dest={{ phpmyadmin_conf }} regexp='// full server array, just define values you need to change.' replace="$cfg['ForceSSL'] = TRUE;"

- name: mkdir tmp
  command: mkdir /var/www/html/wordpress/phpMyAdmin/tmp

- name: chown tmp
  command: chown apache:root /var/www/html/wordpress/phpMyAdmin/tmp

- name: Insert tmp Line in phpMyAdmin config
  replace: dest={{ phpmyadmin_conf }} regexp="// to ''. If you want more than one server, just copy following section" replace="$cfg['TempDir'] = './tmp/';"

- name: ln phpMyAdmin 
  command: ln -s {{ www_wordpress }}/phpMyAdmin {{ www_wordpress }}/phpmyadmin

- name: copy phpMyAdmin conf
  copy: src=phpMyAdmin.conf dest={{ httpd_conf_d }}

- name: cp phpMyAdmin config.inc.php
  command: cp /etc/phpMyAdmin/config.inc.php /var/www/html/wordpress/phpMyAdmin/

- name: chown phpMyAdmin config.inc.php
  command: chown root:apache /var/www/html/wordpress/phpMyAdmin/config.inc.php

- name: start apache
  command: /etc/init.d/httpd start

- name: start Nginx
  command: service nginx start

- name: Enable Httpd
  command: /sbin/chkconfig httpd on

- name: Enable Nginx
  command: /sbin/chkconfig nginx on

